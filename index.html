<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <title>Quiz Player</title>

  <style>
    :root{
      --pad: 16px;
      --radius: 16px;
      --border: 1px solid #e5e5e5;
      --tap: 56px;
      --text: 18px; /* >=16 para evitar zoom en iOS */
    }

    html, body { height: 100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Arial, sans-serif;
      line-height:1.35;
      font-size: var(--text);
      background:#fff;
      -webkit-text-size-adjust: 100%;
      padding:
        calc(var(--pad) + env(safe-area-inset-top))
        calc(var(--pad) + env(safe-area-inset-right))
        calc(var(--pad) + env(safe-area-inset-bottom))
        calc(var(--pad) + env(safe-area-inset-left));
      max-width: 820px;
      margin-left:auto;
      margin-right:auto;
    }

    h2{ margin: 0 0 12px 0; font-size: 22px; }
    h3{ margin: 0 0 10px 0; }
    .card{
      border: var(--border);
      border-radius: var(--radius);
      padding: 14px;
      margin: 12px 0;
      background: #fff;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .muted{ color:#666; font-size: 14px; }
    .pill{
      display:inline-block;
      border: var(--border);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 13px;
      background:#fafafa;
    }

    button{
      width:100%;
      min-height: var(--tap);
      padding: 14px 14px;
      font-size: 18px;
      border-radius: 14px;
      border: 1px solid #cfcfcf;
      background:#fff;
      text-align:left;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
    }
    button:active{ transform: scale(0.99); }
    button:disabled{ opacity: 0.75; }

    .btn-row button{
      width: auto;
      text-align:center;
      min-height: 46px;
      font-size: 16px;
      padding: 10px 14px;
    }

    input[type="file"]{
      font-size: 16px;
      width: 100%;
    }

    .good{ border-color:#2e9b2e; }
    .bad{ border-color:#c84b4b; }

    .topbar{
      position: sticky;
      top: calc(env(safe-area-inset-top));
      z-index: 10;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: var(--border);
      border-radius: var(--radius);
      padding: 10px 12px;
      margin-bottom: 12px;
    }
    .topbar .row{ justify-content: space-between; }

    .review-item{
      border: var(--border);
      border-radius: var(--radius);
      padding: 12px;
      margin-top: 10px;
      background: #fff;
    }
    .review-item.wrong{ border-color:#e7a0a0; }
    .review-item.right{ border-color:#9ad29a; }
    .review-line{ margin-top: 6px; font-size: 16px; }
    .label{ font-size: 13px; color:#666; }
    .ans{ font-weight: 600; }
  </style>
</head>

<body>
  <h2>Quiz Player</h2>

  <div class="card">
    <div class="row" style="margin-bottom:10px;">
      <input id="file" type="file" accept=".json,application/json" />
    </div>

    <div class="row btn-row">
      <button id="start" disabled>Empezar</button>
      <button id="restart" disabled>Reiniciar</button>
    </div>

    <div id="meta" class="muted" style="margin-top:10px;">
      Carga un archivo <b>.json</b> con preguntas.
    </div>
  </div>

  <div id="topbar" class="topbar" style="display:none;">
    <div class="row">
      <div class="muted" id="progress">—</div>
      <div class="muted" id="points">Puntos: 0</div>
    </div>
  </div>

  <div id="app"></div>

<script>
let quiz = null;
let idx = 0;
let score = 0;
let answered = false;
let responses = []; // {q, options, selected, correctIndex, hint}

const elFile = document.getElementById("file");
const elStart = document.getElementById("start");
const elRestart = document.getElementById("restart");
const elMeta = document.getElementById("meta");
const elTopbar = document.getElementById("topbar");
const elProgress = document.getElementById("progress");
const elPoints = document.getElementById("points");
const app = document.getElementById("app");

function esc(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

elFile.addEventListener("change", async (e) => {
  const f = e.target.files?.[0];
  if(!f) return;

  const text = await f.text();
  try{
    quiz = JSON.parse(text);
    validateQuiz(quiz);

    elMeta.innerHTML = `
      <div><span class="pill">Título</span> <b>${esc(quiz.title || "Sin título")}</b></div>
      <div style="margin-top:6px;">
        <span class="pill">Tema</span> ${esc(quiz.topic || "—")}
        &nbsp; <span class="pill">Preguntas</span> ${quiz.questions.length}
      </div>
      <div class="muted" style="margin-top:6px;">Listo. Pulsa <b>Empezar</b>.</div>
    `;

    elStart.disabled = false;
    elRestart.disabled = false;
    app.innerHTML = "";
    elTopbar.style.display = "none";
  }catch(err){
    quiz = null;
    elStart.disabled = true;
    elRestart.disabled = true;
    app.innerHTML = "";
    elTopbar.style.display = "none";
    elMeta.textContent = "Error: el archivo no es JSON válido o no cumple el formato del quiz.";
    console.error(err);
  }
});

elStart.onclick = () => startQuiz();
elRestart.onclick = () => startQuiz();

function startQuiz(){
  idx = 0;
  score = 0;
  answered = false;
  responses = [];
  render();
}

function validateQuiz(q){
  if(!q || typeof q !== "object") throw new Error("quiz no es objeto");
  if(!Array.isArray(q.questions) || q.questions.length === 0) throw new Error("sin preguntas");
  q.questions.forEach((it, n) => {
    if(typeof it.q !== "string") throw new Error("pregunta q inválida #" + n);
    if(!Array.isArray(it.options) || it.options.length < 2) throw new Error("options inválidas #" + n);
    if(typeof it.answer !== "number" || it.answer < 0 || it.answer >= it.options.length) throw new Error("answer inválida #" + n);
  });
}

function updateTopbar(){
  if(!quiz) return;
  elTopbar.style.display = "block";
  elProgress.textContent = `Pregunta ${Math.min(idx+1, quiz.questions.length)} / ${quiz.questions.length}`;
  elPoints.textContent = `Puntos: ${score}`;
}

function render(){
  app.innerHTML = "";

  if(!quiz){
    app.innerHTML = `<div class="card muted">Primero carga un archivo .json.</div>`;
    elTopbar.style.display = "none";
    return;
  }

  updateTopbar();

  if(idx >= quiz.questions.length){
    const total = quiz.questions.length;
    const percent = Math.round((score/total)*100);

    const wrong = responses
      .map((r, i) => ({...r, n: i+1}))
      .filter(r => r.selected !== r.correctIndex);

    const reviewHtml = wrong.length === 0
      ? `<div class="review-item right"><div class="label">Revisión</div><div class="review-line">Perfecto: no tuviste errores. ✅</div></div>`
      : wrong.map(r => `
          <div class="review-item wrong">
            <div class="label">Error • Pregunta ${r.n}</div>
            <div class="review-line"><b>${esc(r.q)}</b></div>
            ${r.hint ? `<div class="muted" style="margin-top:6px;">Pista: ${esc(r.hint)}</div>` : ""}
            <div class="review-line"><span class="label">Tu respuesta:</span> <span class="ans">${esc(r.options[r.selected])}</span></div>
            <div class="review-line"><span class="label">Correcta:</span> <span class="ans">${esc(r.options[r.correctIndex])}</span></div>
          </div>
        `).join("");

    app.innerHTML = `
      <div class="card">
        <h3>Resultado</h3>
        <p style="margin:0 0 8px 0;"><b>${score}</b> / ${total} (${percent}%)</p>
        <div class="muted">${esc(quiz.title || "")} — ${esc(quiz.topic || "")}</div>
        <button style="margin-top:12px;text-align:center" onclick="startQuiz()">Repetir</button>
      </div>

      <div class="card">
        <h3>Revisión de errores</h3>
        <div class="muted" style="margin-bottom:8px;">Aquí ves en qué fallaste y cuál era la correcta.</div>
        ${reviewHtml}
      </div>
    `;

    elProgress.textContent = `Terminado`;
    elPoints.textContent = `Puntos: ${score}`;
    return;
  }

  const item = quiz.questions[idx];

  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <h3>${esc(item.q)}</h3>
    ${item.hint ? `<div class="muted" style="margin-bottom:10px;">Pista: ${esc(item.hint)}</div>` : ""}
  `;

  item.options.forEach((opt, i) => {
    const b = document.createElement("button");
    b.textContent = opt;
    b.onclick = () => pick(i);
    card.appendChild(b);
    card.appendChild(document.createElement("div")).style.height = "10px";
  });

  app.appendChild(card);
  answered = false;
}

function pick(i){
  if(answered) return;
  answered = true;

  const item = quiz.questions[idx];
  responses.push({
    q: item.q,
    options: item.options.slice(),
    selected: i,
    correctIndex: item.answer,
    hint: item.hint || ""
  });

  if(i === item.answer) score++;
  updateTopbar();

  const btns = app.querySelectorAll("button");
  btns.forEach((b, j) => {
    if(j === item.answer) b.classList.add("good");
    if(j === i && i !== item.answer) b.classList.add("bad");
    b.disabled = true;
  });

  setTimeout(() => { idx++; answered=false; render(); }, 450);
}

render();
</script>
</body>
</html>
